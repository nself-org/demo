###############################################################################
# nSelf Backend Stack - Local Development
#
# This Docker Compose file runs the complete nSelf backend locally:
#   - PostgreSQL 16 (database)
#   - Hasura GraphQL Engine (API layer)
#   - Hasura Auth (authentication)
#   - Hasura Storage (file storage)
#   - Mailhog (local email testing)
#
# Usage:
#   cp .env.example .env   # then edit .env with your values
#   docker compose up -d
#
# Endpoints (default):
#   GraphQL:    http://localhost:8080/v1/graphql
#   Console:    http://localhost:8080/console
#   Auth:       http://localhost:4000
#   Storage:    http://localhost:8484
#   Mailhog:    http://localhost:8025
#   Postgres:   localhost:5432
###############################################################################

version: "3.9"

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-nself}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ---------------------------------------------------------------------------
  # Hasura GraphQL Engine
  # ---------------------------------------------------------------------------
  graphql-engine:
    image: hasura/graphql-engine:v2.42.0
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${HASURA_PORT:-8080}:8080"
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nself}
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-nself-admin-secret}
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256","key":"${AUTH_JWT_SECRET:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}"}'
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true"
      HASURA_GRAPHQL_DEV_MODE: "true"
      HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup,http-log,webhook-log,websocket-log,query-log
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: public
      HASURA_GRAPHQL_CORS_DOMAIN: "*"
      HASURA_GRAPHQL_ENABLE_REMOTE_SCHEMA_PERMISSIONS: "true"
      HASURA_GRAPHQL_ENABLE_TELEMETRY: "false"
      HASURA_GRAPHQL_EXPERIMENTAL_FEATURES: naming_convention
      HASURA_GRAPHQL_DEFAULT_NAMING_CONVENTION: graphql-default
      AUTH_HOOK: http://auth:4000/webhook
      AUTH_HOOK_MODE: POST
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ---------------------------------------------------------------------------
  # Hasura Auth (Authentication Service)
  # ---------------------------------------------------------------------------
  auth:
    image: nhost/hasura-auth:0.32.1
    restart: unless-stopped
    depends_on:
      graphql-engine:
        condition: service_healthy
    ports:
      - "${AUTH_PORT:-4000}:4000"
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nself}
      HASURA_GRAPHQL_GRAPHQL_URL: http://graphql-engine:8080/v1/graphql
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-nself-admin-secret}
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256","key":"${AUTH_JWT_SECRET:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}"}'
      AUTH_HOST: 0.0.0.0
      AUTH_PORT: 4000
      AUTH_SERVER_URL: ${AUTH_SERVER_URL:-http://localhost:4000}
      AUTH_CLIENT_URL: ${AUTH_CLIENT_URL:-http://localhost:3000}
      AUTH_ACCESS_TOKEN_EXPIRES_IN: ${AUTH_ACCESS_TOKEN_EXPIRES_IN:-900}
      AUTH_REFRESH_TOKEN_EXPIRES_IN: ${AUTH_REFRESH_TOKEN_EXPIRES_IN:-43200}
      AUTH_EMAIL_PASSWORDLESS_ENABLED: ${AUTH_EMAIL_PASSWORDLESS_ENABLED:-false}
      AUTH_EMAIL_SIGNIN_EMAIL_VERIFIED_REQUIRED: ${AUTH_REQUIRE_EMAIL_VERIFICATION:-false}
      AUTH_ANONYMOUS_USERS_ENABLED: ${AUTH_ANONYMOUS_USERS_ENABLED:-false}
      AUTH_DISABLE_NEW_USERS: ${AUTH_DISABLE_NEW_USERS:-false}
      AUTH_LOCALE_DEFAULT: ${AUTH_LOCALE_DEFAULT:-en}
      AUTH_GRAVATAR_ENABLED: ${AUTH_GRAVATAR_ENABLED:-true}
      AUTH_GRAVATAR_DEFAULT: mp
      AUTH_SMTP_HOST: ${SMTP_HOST:-mailhog}
      AUTH_SMTP_PORT: ${SMTP_PORT:-1025}
      AUTH_SMTP_USER: ${SMTP_USER:-}
      AUTH_SMTP_PASS: ${SMTP_PASS:-}
      AUTH_SMTP_SENDER: ${SMTP_SENDER:-no-reply@localhost}
      AUTH_SMTP_SECURE: ${SMTP_SECURE:-false}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:4000/healthz"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ---------------------------------------------------------------------------
  # Hasura Storage (File Storage Service)
  # ---------------------------------------------------------------------------
  storage:
    image: nhost/hasura-storage:0.6.1
    restart: unless-stopped
    depends_on:
      graphql-engine:
        condition: service_healthy
    ports:
      - "${STORAGE_PORT:-8484}:8484"
    environment:
      HASURA_GRAPHQL_ADMIN_SECRET: ${HASURA_ADMIN_SECRET:-nself-admin-secret}
      HASURA_METADATA: "1"
      HASURA_ENDPOINT: http://graphql-engine:8080/v1
      POSTGRES_MIGRATIONS: "1"
      POSTGRES_MIGRATIONS_SOURCE: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nself}?sslmode=disable
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioaccesskey}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-miniosecretkey}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_BUCKET: ${S3_BUCKET:-nhost}
      S3_ROOT_FOLDER: ""
      S3_REGION: ""
      PUBLIC_URL: ${STORAGE_PUBLIC_URL:-http://localhost:8484}
      BIND: :8484
    command: serve
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8484/healthz"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ---------------------------------------------------------------------------
  # MinIO (S3-Compatible Object Storage)
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:RELEASE.2024-01-01T16-36-33Z
    restart: unless-stopped
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioaccesskey}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-miniosecretkey}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ---------------------------------------------------------------------------
  # MinIO bucket initialization
  # ---------------------------------------------------------------------------
  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 ${S3_ACCESS_KEY:-minioaccesskey} ${S3_SECRET_KEY:-miniosecretkey};
      mc mb --ignore-existing myminio/${S3_BUCKET:-nhost};
      mc anonymous set download myminio/${S3_BUCKET:-nhost}/public;
      exit 0;
      "

  # ---------------------------------------------------------------------------
  # Mailhog (Local Email Testing - Development Only)
  # ---------------------------------------------------------------------------
  mailhog:
    image: mailhog/mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    profiles:
      - dev
      - local

volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local
